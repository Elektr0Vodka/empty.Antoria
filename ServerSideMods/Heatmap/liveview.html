<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DayZ Heatmap Live View</title>
<style>
:root {
  --bg-color: #1e1e1e;
  --text-color: #f0f0f0;
  --panel-bg: #2b2b2b;
  --panel-border: #444;
  --accent-color: #ffcc00;
  --button-text: #000;
}
body.light {
  --bg-color: #f8f8f8;
  --text-color: #222;
  --panel-bg: #fff;
  --panel-border: #ccc;
  --accent-color: #0077cc;
  --button-text: #fff;
}
body {
  font-family: Arial, sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  margin: 0;
  display: flex;
}
.sidebar {
  width: 220px;
  background: var(--panel-bg);
  border-right: 1px solid var(--panel-border);
  display: flex;
  flex-direction: column;
  padding: 12px;
  gap: 10px;
}
.sidebar button, .sidebar select, .sidebar input[type=number] {
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: var(--accent-color);
  color: var(--button-text);
  font-weight: bold;
}
.sidebar button:hover, .sidebar select:hover, .sidebar input:hover { filter: brightness(0.9); }
.sidebar input[type=file] {
  padding: 6px;
  background: var(--panel-bg);
  color: var(--text-color);
  border: 1px solid var(--panel-border);
  border-radius: 6px;
  cursor: pointer;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  position: relative;
  overflow: hidden;
}
#mapCanvas {
  flex: 1;
  max-width: 100%;
  max-height: 100%;
  border-radius: 8px;
  cursor: grab;
}
#legend {
  margin-top: 10px;
  font-size: 0.9rem;
}
</style>
</head>
<body>

<div class="sidebar">
  <button onclick="window.location='index.html'">Generator</button>
  <button id="themeToggle">Enter the light side</button>
  <button id="resetView">Reset View</button>
  
  <label for="mapSelect">Map:</label>
  <select id="mapSelect">
    <option value="Antoria">Antoria</option>
    <option value="Enoch">Enoch</option>
    <option value="Chernarus">Chernarus</option>
    <option value="Esseker">Esseker</option>
  </select>

  <label>Lookback (minutes):</label>
  <input type="number" id="lookbackTime" value="60" min="1" style="width:60px;">

  <label>Layers:</label>
  <label><input type="checkbox" id="showWaypoints" checked> Waypoints</label>
  <label><input type="checkbox" id="showDeaths" checked> Deaths</label>
  <label><input type="checkbox" id="showStorages" checked> Storages</label>
  <label><input type="checkbox" id="showZombies" checked> Zombies</label>

  <div id="legend">
    <strong>Legend:</strong><br>
    <span id="wpCount">Waypoints: 0</span><br>
    <span id="deathCount">Deaths: 0</span><br>
    <span id="storageCount">Storages: 0</span><br>
    <span id="zombieCount">Zombies: 0</span>
  </div>

  <button id="folderButton">Select Folder</button>
  <input type="file" id="folderPicker" webkitdirectory directory multiple style="display:none;">
</div>

<div class="main">
  <canvas id="mapCanvas"></canvas>
  <div id="statusBox">No files loaded</div>
</div>

<script>
const mapSize = new Map([
  ["Antoria", 20480], ["Enoch", 12800], ["Chernarus", 15360], ["Esseker", 12800]
]);
const mapImage = new Map([
  ["Antoria", "https://raw.githubusercontent.com/Elektr0Vodka/empty.Antoria/main/ServerSideMods/Heatmap/map.png"],
  ["Enoch", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/Enoch/map.png"],
  ["Chernarus", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/ChernarusPlus/map.png"],
  ["Esseker", "https://github.com/InclementDab/Esseker-Server/raw/main/Central%20Economy%20Tool/map.png"]
]);

let currentMap="Antoria";
let waypoints=[], deaths=[], storages=[], zombies=[], lastLoaded=[];
let lookbackMinutes=60;
let canvas=document.getElementById("mapCanvas");
let ctx=canvas.getContext("2d");
let zoom=1, offsetX=0, offsetY=0;
let isDragging=false, dragStart={x:0,y:0}, lastOffset={x:0,y:0};

function resizeCanvas(){
  canvas.width=window.innerWidth-220-20;
  canvas.height=window.innerHeight-20;
  drawAll();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

document.getElementById("mapSelect").addEventListener("change", ()=>{
  currentMap=document.getElementById("mapSelect").value;
  zoom=1; offsetX=0; offsetY=0;
  drawAll();
});

document.getElementById("themeToggle").addEventListener("click", ()=>{
  document.body.classList.toggle("light");
  document.getElementById("themeToggle").textContent=document.body.classList.contains("light")?"Enter the dark side":"Enter the light side";
  drawAll();
});

document.getElementById("resetView").addEventListener("click", ()=>{
  zoom=1; offsetX=0; offsetY=0;
  drawAll();
});

document.getElementById("folderButton").addEventListener("click", ()=>document.getElementById("folderPicker").click());
document.getElementById("folderPicker").addEventListener("change", e=>{
  const files=e.target.files;
  waypoints=[]; deaths=[]; storages=[]; zombies=[]; lastLoaded=[];
  readFiles(files,true);
  startAutoReload(files);
});

// Layer toggles
const layerToggles={
  waypoints: document.getElementById("showWaypoints"),
  deaths: document.getElementById("showDeaths"),
  storages: document.getElementById("showStorages"),
  zombies: document.getElementById("showZombies")
};
Object.values(layerToggles).forEach(cb=>cb.addEventListener("change",()=>drawAll()));

// Zoom & pan
canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;
  const delta=-e.deltaY*0.0015;
  const newZoom=Math.min(Math.max(zoom+delta,0.5),5);
  offsetX-=(mx-canvas.width/2-offsetX)*(newZoom/zoom-1);
  offsetY-=(my-canvas.height/2-offsetY)*(newZoom/zoom-1);
  zoom=newZoom;
  drawAll();
});
canvas.addEventListener("mousedown", e=>{isDragging=true; dragStart={x:e.clientX,y:e.clientY}; lastOffset={x:offsetX,y:offsetY}; canvas.style.cursor="grabbing";});
canvas.addEventListener("mouseup", ()=>{isDragging=false; canvas.style.cursor="grab";});
canvas.addEventListener("mouseleave", ()=>{isDragging=false; canvas.style.cursor="grab";});
canvas.addEventListener("mousemove", e=>{
  if(isDragging){ offsetX=lastOffset.x+(e.clientX-dragStart.x); offsetY=lastOffset.y+(e.clientY-dragStart.y); drawAll(); }
});

// --- File parsing ---
function readFiles(files, initial){
  Array.from(files).filter(f=>f.name.toLowerCase().endsWith(".json")).forEach(f=>{
    if(initial||!lastLoaded.includes(f.name)){
      const r=new FileReader();
      r.onload=()=>{
        try{
          const d=JSON.parse(r.result);
          if(d.m_WayPoints) waypoints.push(...d.m_WayPoints.map(p=>({x:p[0], z:p[2], time:p.time})));
          if(d.m_DeathPoints) deaths.push(...d.m_DeathPoints.map(p=>({x:p[0], z:p[2], time:p.time})));
          if(d.m_StoragePoints) storages.push(...d.m_StoragePoints.map(p=>({x:p[0], z:p[2], time:p.time})));
          if(d.m_ZombiePoints) zombies.push(...d.m_ZombiePoints.map(p=>({x:p[0], z:p[2], time:p.time})));
          // Nested placeables
          if(d.placeables) d.placeables.forEach(p=>{
            if(p.type==="WayPoint") waypoints.push({x:p.x, z:p.z, time:p.time});
            if(p.type==="DeathPoint") deaths.push({x:p.x, z:p.z, time:p.time});
            if(p.type==="StoragePoint") storages.push({x:p.x, z:p.z, time:p.time});
            if(p.type==="ZombiePoint") zombies.push({x:p.x, z:p.z, time:p.time});
          });
          drawAll();
          document.getElementById("statusBox").textContent=`Loaded ${lastLoaded.length+1} file(s)`;
        }catch(e){console.error("Parse failed",f.name,e);}
      };
      r.readAsText(f);
      lastLoaded.push(f.name);
    }
  });
}
function startAutoReload(files){
  setInterval(()=>{
    lookbackMinutes=parseInt(document.getElementById("lookbackTime").value)||60;
    const newFiles=Array.from(files).filter(f=>f.name.toLowerCase().endsWith(".json")&&!lastLoaded.includes(f.name));
    if(newFiles.length>0) readFiles(newFiles,false);
  },30000);
}

// --- Drawing ---
function drawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!mapImage.has(currentMap)) return;
  const img=new Image();
  img.src=mapImage.get(currentMap);
  img.onload=()=>{
    const aspect=img.width/img.height;
    let w=canvas.width,h=canvas.height;
    if(canvas.width/canvas.height>aspect){ w=canvas.height*aspect; h=canvas.height; }
    else { h=canvas.width/aspect; w=canvas.width; }
    ctx.save();
    ctx.translate(canvas.width/2+offsetX, canvas.height/2+offsetY);
    ctx.scale(zoom, zoom);
    ctx.drawImage(img,-w/2,-h/2,w,h);
    renderPoints(w,h);
    ctx.restore();
  }
}
function renderPoints(mapW,mapH){
  const size=mapSize.get(currentMap);
  const cutoff=Date.now()-lookbackMinutes*60*1000;
  ctx.globalAlpha=0.6;
  let wp=0, dp=0, sp=0, zp=0;

  if(layerToggles.waypoints.checked)
    waypoints.forEach(p=>{ if(!p.time||Date.parse(p.time)>=cutoff){ let x=mapW/size*p.x-mapW/2; let y=mapH/size*(size-p.z)-mapH/2; ctx.fillStyle="rgba(255,0,0,0.5)"; ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill(); wp++; }});
  if(layerToggles.deaths.checked)
    deaths.forEach(p=>{ if(!p.time||Date.parse(p.time)>=cutoff){ let x=mapW/size*p.x-mapW/2; let y=mapH/size*(size-p.z)-mapH/2; ctx.fillStyle="yellow"; ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill(); dp++; }});
  if(layerToggles.storages.checked)
    storages.forEach(p=>{ if(!p.time||Date.parse(p.time)>=cutoff){ let x=mapW/size*p.x-mapW/2; let y=mapH/size*(size-p.z)-mapH/2; ctx.fillStyle="red"; ctx.beginPath(); ctx.rect(x-4,y-4,8,8); ctx.fill(); sp++; }});
  if(layerToggles.zombies.checked)
    zombies.forEach(p=>{ if(!p.time||Date.parse(p.time)>=cutoff){ let x=mapW/size*p.x-mapW/2; let y=mapH/size*(size-p.z)-mapH/2; ctx.fillStyle="darkorange"; ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill(); zp++; }});

  document.getElementById("wpCount").textContent="Waypoints: "+wp;
  document.getElementById("deathCount").textContent="Deaths: "+dp;
  document.getElementById("storageCount").textContent="Storages: "+sp;
  document.getElementById("zombieCount").textContent="Zombies: "+zp;

  ctx.globalAlpha=1.0;
}
</script>
</body>
</html>
