<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DayZ Heatmap Generator</title>
<style>
:root {
  --bg-color: #1e1e1e;
  --text-color: #f0f0f0;
  --panel-bg: #2b2b2b;
  --panel-border: #444;
  --accent-color: #ffcc00;
  --button-text: #000;
}
body {
  font-family: Arial, sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  margin: 0;
  display: flex;
}
.sidebar {
  width: 220px;
  background: var(--panel-bg);
  border-right: 1px solid var(--panel-border);
  display: flex;
  flex-direction: column;
  padding: 12px;
  gap: 10px;
}
.sidebar button, .sidebar select, .sidebar input {
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: var(--accent-color);
  color: var(--button-text);
  font-weight: bold;
}
.sidebar button:hover, .sidebar select:hover, .sidebar input:hover { filter: brightness(0.9); }

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  position: relative;
}
#mapCanvas {
  flex: 1;
  border-radius: 8px;
  cursor: grab;
}
#legend {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: rgba(43,43,43,0.85);
  border: 1px solid var(--panel-border);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.9rem;
  color: var(--text-color);
}
</style>
</head>
<body>
<div class="sidebar">
  <button onclick="window.location='liveview.html'">Live View</button>

  <label for="mapSelect">Map:</label>
  <select id="mapSelect">
    <option value="Antoria">Antoria</option>
    <option value="Enoch">Enoch</option>
    <option value="Chernarus">Chernarus</option>
    <option value="Esseker">Esseker</option>
  </select>

  <label for="timeSlider">Time:</label>
  <input type="range" id="timeSlider" min="0" max="1" value="1" step="0.01">

  <label for="intensitySlider">Intensity:</label>
  <input type="range" id="intensitySlider" min="1" max="5" value="2" step="0.1">

  <label>Layers:</label>
  <label><input type="checkbox" id="showWaypoints" checked> Waypoints</label>
  <label><input type="checkbox" id="showDeaths" checked> Deaths</label>
  <label><input type="checkbox" id="showStorages" checked> Storages</label>
  <label><input type="checkbox" id="showZombies" checked> Zombies</label>
  <label><input type="checkbox" id="showLegend" checked> Legend</label>

  <button onClick="document.getElementById('folderPicker').click()">Upload Folder</button>
  <input type="file" id="folderPicker" webkitdirectory directory multiple style="display:none;">

  <button onClick="document.getElementById('jsonPicker').click()">Upload Heatmap.JSON</button>
  <input type="file" id="jsonPicker" accept=".json" style="display:none;">

  <button onClick="save()">Export PNG</button>
</div>

<div class="main">
  <canvas id="mapCanvas"></canvas>
  <div id="legend">Legend:<br>
    <span id="wpCount">Waypoints: 0</span><br>
    <span id="deathCount">Deaths: 0</span><br>
    <span id="storageCount">Storages: 0</span><br>
    <span id="zombieCount">Zombies: 0</span>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// Map settings
const mapSize = new Map([
  ["Antoria", 20480], ["Enoch", 12800], ["Chernarus", 15360], ["Esseker", 12800]
]);
const mapImage = new Map([
  ["Antoria", "https://raw.githubusercontent.com/Elektr0Vodka/empty.Antoria/main/ServerSideMods/Heatmap/map.png"],
  ["Enoch", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/Enoch/map.png"],
  ["Chernarus", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/ChernarusPlus/map.png"],
  ["Esseker", "https://github.com/InclementDab/Esseker-Server/raw/main/Central%20Economy%20Tool/map.png"]
]);

let currentMap = "Antoria";
let datasets = []; // array of {name, waypoints, deaths, storages, zombies}
let canvas = document.getElementById("mapCanvas");
let ctx = canvas.getContext("2d");
let mapImg = new Image();

// Zoom/pan variables
let scale = 1, offsetX = 0, offsetY = 0, isDragging = false, dragStart = {x:0,y:0};

// Resize canvas
function resizeCanvas(){
  canvas.width = window.innerWidth - 240;
  canvas.height = window.innerHeight;
  drawAll();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Map select
document.getElementById("mapSelect").addEventListener("change", ()=>{
  currentMap = document.getElementById("mapSelect").value;
  drawAll();
});

// File uploads
document.getElementById("folderPicker").addEventListener("change", e=>loadFiles(e.target.files));
document.getElementById("jsonPicker").addEventListener("change", e=>loadFiles(e.target.files));

function loadFiles(files){
  Array.from(files).filter(f=>f.name.toLowerCase().endsWith(".json")).forEach(f=>{
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const d = JSON.parse(r.result);
        datasets.push({
          name: f.name,
          waypoints: d.m_WayPoints || [],
          deaths: d.m_DeathPoints || [],
          storages: d.m_StoragePoints || [],
          zombies: d.m_ZombiePoints || []
        });
        drawAll();
      }catch(e){console.error(e);}
    };
    r.readAsText(f);
  });
}

// Zoom & pan events
canvas.addEventListener("mousedown", e => {
  isDragging = true;
  dragStart.x = e.clientX - offsetX;
  dragStart.y = e.clientY - offsetY;
  canvas.style.cursor = "grabbing";
});
canvas.addEventListener("mousemove", e => {
  if(isDragging){
    offsetX = e.clientX - dragStart.x;
    offsetY = e.clientY - dragStart.y;
    drawAll();
  }
});
canvas.addEventListener("mouseup", ()=>{ isDragging=false; canvas.style.cursor="grab"; });
canvas.addEventListener("mouseleave", ()=>{ isDragging=false; canvas.style.cursor="grab"; });
canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  const zoomAmount = -e.deltaY * 0.001;
  const mx = e.offsetX, my = e.offsetY;
  const newScale = Math.min(Math.max(scale*(1+zoomAmount),0.5),5);
  offsetX = mx - (mx - offsetX)*(newScale/scale);
  offsetY = my - (my - offsetY)*(newScale/scale);
  scale = newScale;
  drawAll();
});

// Draw map & points
function drawAll(){
  if(!mapImage.has(currentMap)) return;
  mapImg.src = mapImage.get(currentMap);
  mapImg.onload = ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(scale, scale);

    const aspect = mapImg.width/mapImg.height;
    let w = canvas.width, h = canvas.height;
    if(canvas.width/canvas.height > aspect){ w = canvas.height*aspect; h = canvas.height; }
    else { h = canvas.width/aspect; w = canvas.width; }
    ctx.drawImage(mapImg,(canvas.width-w)/2,(canvas.height-h)/2,w,h);
    renderPoints(w,h);

    ctx.restore();
  };
}

function renderPoints(mapW,mapH){
  const size = mapSize.get(currentMap);
  const timeSlider = parseFloat(document.getElementById("timeSlider").value);
  const intensity = parseFloat(document.getElementById("intensitySlider").value);
  let wp=0, dp=0, sp=0, zp=0;
  const centerX=(canvas.width-mapW)/2;
  const centerY=(canvas.height-mapH)/2;

  const count = Math.floor(datasets.length * timeSlider);

  for(let k=0;k<count;k++){
    const ds = datasets[k];

    if(document.getElementById("showWaypoints").checked){
      ctx.fillStyle = `rgba(255,0,0,${0.05*intensity})`;
      ds.waypoints.forEach(p=>{
        wp++;
        let x = mapW/size*p[0]+centerX;
        let y = mapH/size*(size-p[2])+centerY;
        ctx.beginPath();
        ctx.arc(x,y,20,0,2*Math.PI);
        ctx.fill();
      });
    }

    if(document.getElementById("showDeaths").checked){
      ctx.fillStyle = "black";
      ds.deaths.forEach(p=>{
        dp++;
        let x = mapW/size*p[0]+centerX;
        let y = mapH/size*(size-p[2])+centerY;
        ctx.fillRect(x-2,y-2,4,4);
      });
    }

    if(document.getElementById("showStorages").checked){
      ctx.fillStyle = "blue";
      ds.storages.forEach(p=>{
        sp++;
        let x = mapW/size*p[0]+centerX;
        let y = mapH/size*(size-p[2])+centerY;
        ctx.fillRect(x-3,y-3,6,6);
      });
    }

    if(document.getElementById("showZombies").checked){
      ctx.fillStyle = "green";
      ds.zombies.forEach(p=>{
        zp++;
        let x = mapW/size*p[0]+centerX;
        let y = mapH/size*(size-p[2])+centerY;
        ctx.beginPath();
        ctx.arc(x,y,3,0,2*Math.PI);
        ctx.fill();
      });
    }
  }

  document.getElementById("wpCount").textContent="Waypoints: "+wp;
  document.getElementById("deathCount").textContent="Deaths: "+dp;
  document.getElementById("storageCount").textContent="Storages: "+sp;
  document.getElementById("zombieCount").textContent="Zombies: "+zp;

  document.getElementById("legend").style.display=document.getElementById("showLegend").checked?"block":"none";
}

// Event listeners
["timeSlider","intensitySlider","showWaypoints","showDeaths","showStorages","showZombies","showLegend"]
.forEach(id=>document.getElementById(id).addEventListener("input",drawAll));

// Export PNG
function save(){
  const includeLegend=document.getElementById("showLegend").checked;
  let exportCanvas=document.createElement("canvas");
  exportCanvas.width=canvas.width;
  exportCanvas.height=canvas.height;
  let ex=exportCanvas.getContext("2d");
  ex.drawImage(canvas,0,0);

  if(includeLegend){
    ex.fillStyle="rgba(43,43,43,0.85)";
    ex.fillRect(exportCanvas.width-160,exportCanvas.height-100,150,90);
    ex.fillStyle="white";
    ex.font="14px Arial";
    ex.fillText(document.getElementById("wpCount").textContent,exportCanvas.width-150,exportCanvas.height-80);
    ex.fillText(document.getElementById("deathCount").textContent,exportCanvas.width-150,exportCanvas.height-65);
    ex.fillText(document.getElementById("storageCount").textContent,exportCanvas.width-150,exportCanvas.height-50);
    ex.fillText(document.getElementById("zombieCount").textContent,exportCanvas.width-150,exportCanvas.height-35);
  }

  exportCanvas.toBlob(blob=>saveAs(blob,"heatmap.png"));
}
</script>
</body>
</html>
