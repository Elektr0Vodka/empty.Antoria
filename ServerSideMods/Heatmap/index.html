<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DayZ Heatmap</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --text-color: #f0f0f0;
      --panel-bg: #2b2b2b;
      --panel-border: #444;
      --accent-color: #ffcc00;
      --button-text: #000;
      --theme-button-bg: #ffcc00;
      --theme-button-text: #000;
    }

    body.light {
      --bg-color: #f8f8f8;
      --text-color: #222;
      --panel-bg: #fff;
      --panel-border: #ccc;
      --accent-color: #0077cc;
      --button-text: #fff;
      --theme-button-bg: #0077cc;
      --theme-button-text: #fff;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      margin: 20px 0 10px 0;
      font-size: 1.8rem;
      color: var(--accent-color);
      transition: color 0.3s;
    }

    .info-box {
      max-width: 900px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.4rem;
      text-align: left;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px 25px;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }

    label {
      font-weight: bold;
      margin-right: 6px;
    }

    select, input[type=range], button {
      background: var(--panel-bg);
      color: var(--text-color);
      border: 1px solid var(--panel-border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.95rem;
      transition: all 0.2s ease-in-out;
    }

    select:hover, button:hover {
      background: var(--panel-border);
      cursor: pointer;
    }

    input[type=range] {
      width: 160px;
      cursor: pointer;
    }

    .map-wrapper {
      background: var(--panel-bg);
      border: 3px solid var(--panel-border);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.4);
      margin-bottom: 10px;
      transition: background 0.3s, border 0.3s;
    }

    #mapImage {
      width: 1000px;
      height: 1000px;
      background-size: 100% 100%;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    #mapCanvas {
      display: block;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions button {
      padding: 8px 14px;
      background: var(--accent-color);
      color: var(--button-text);
      font-weight: bold;
      border: none;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .actions button:hover {
      filter: brightness(0.9);
    }

    #themeToggle {
      background: var(--theme-button-bg);
      color: var(--theme-button-text);
    }

    #statusBox {
      margin: 10px 0 20px 0;
      font-size: 0.9rem;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      padding: 8px 12px;
      border-radius: 6px;
      min-height: 20px;
      max-width: 900px;
      text-align: center;
    }

    .checkbox-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .checkbox-group label {
      font-weight: normal;
    }
  </style>
</head>
<body>

  <h1>DayZ Heatmap Generator</h1>

  <div class="info-box">
    <p><strong>How to use:</strong></p>
    <ul>
      <li>Select a <strong>map</strong> from the dropdown or load your own.</li>
      <li>Drag &amp; drop your exported <code>.json</code> data files onto the map area <em>or</em> use the <strong>Select Folder</strong> button.</li>
      <li>Use the <strong>time slider</strong> to filter events over time.</li>
      <li>Use the <strong>layer toggles</strong> to show/hide Waypoints, Deaths, Storages, and Zombies.</li>
      <li>Adjust <strong>heatmap intensity</strong> for better visibility.</li>
      <li>Click <strong>Merge Data and Map</strong> to export a combined image.</li>
      <li>Switch between <strong>dark</strong> and <strong>light</strong> themes using the toggle button.</li>
    </ul>
  </div>

  <div class="controls">
    <div>
      <label for="mapSelect">Map:</label>
      <select id="mapSelect" onchange="changeMap()">
        <option value="Antoria">Antoria</option>
        <option value="Enoch">Enoch</option>
        <option value="Chernarus">Chernarus</option>
        <option value="Esseker">Esseker</option>
      </select>
    </div>

    <div>
      <label for="timeSlider">Time:</label>
      <input id="timeSlider" type="range" min="0" max="1" value="1" step="0.01">
    </div>

    <div>
      <label for="intensitySlider">Intensity:</label>
      <input id="intensitySlider" type="range" min="1" max="5" value="2" step="0.1">
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="showWaypoints" checked>
      <label for="showWaypoints">Waypoints</label>
      <input type="checkbox" id="showDeaths" checked>
      <label for="showDeaths">Deaths</label>
      <input type="checkbox" id="showStorages" checked>
      <label for="showStorages">Storages</label>
      <input type="checkbox" id="showZombies" checked>
      <label for="showZombies">Zombies</label>
    </div>

    <div>
      <button id="themeToggle" onclick="toggleTheme()">Enter the light side</button>
    </div>
  </div>

  <div id="statusBox">No files loaded</div>

  <div id="dropbox" class="map-wrapper">
    <div id="mapImage">
      <canvas id="mapCanvas" width="1000" height="1000"></canvas>
    </div>
    <div class="actions">
      <button onClick="save();">Merge Data and Map</button>
      <button onClick="selectFolder();">Select Folder</button>
    </div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    var mapSize = new Map();
    mapSize.set("Antoria", 20480);
    mapSize.set("Enoch", 12800);
    mapSize.set("Chernarus", 15360);
    mapSize.set("Esseker", 12800);

    var mapImage = new Map();
    mapImage.set("Antoria", "https://raw.githubusercontent.com/Elektr0Vodka/empty.Antoria/main/ServerSideMods/Heatmap/map.png");
    mapImage.set("Enoch", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/Enoch/map.png");
    mapImage.set("Chernarus", "https://github.com/BohemiaInteractive/DayZ-Central-Economy/raw/master/CETool/ChernarusPlus/map.png");
    mapImage.set("Esseker", "https://github.com/InclementDab/Esseker-Server/raw/main/Central%20Economy%20Tool/map.png");

    var waypoints = [];
    var deathpoints = [];
    var storagepoints = [];
    var zombiepoints = [];
    var maxTime = 0.0;

    changeMap();

    let dropbox = document.getElementById("dropbox");
    dropbox.addEventListener('dragover', e => e.preventDefault(), false);
    dropbox.addEventListener("drop", e => {
      e.preventDefault();
      readFiles(e.dataTransfer.files);
    }, false);

    function setStatus(msg) {
      document.getElementById("statusBox").textContent = msg;
    }

    function changeMap() {
      let canvas = document.getElementById("mapCanvas");
      let ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let mapSelect = document.getElementById("mapSelect");
      let value = mapSelect.value;
      if (mapImage.has(value)) {
        let url = mapImage.get(value);
        document.getElementById("mapImage").style.backgroundImage = "url('"+url+"')";
      } else {
        loadLocalMap();
        let size = prompt("Size of the map", "12800");
        mapSize.set("Local Map", parseInt(size));
      }
    }

    function loadLocalMap() {
      let input = document.createElement("input");
      input.type = "file";
      input.accept=".jpg, .png, .jpeg"
      input.onchange = _ => {
        let files = Array.from(input.files);
        const reader = new FileReader();
        reader.onloadend = function() {
          document.getElementById("mapImage").style.backgroundImage = "url('"+reader.result+"')";
        }
        if(files[0]) reader.readAsDataURL(files[0]);
      };
      input.click();
    }

    function selectFolder() {
      let input = document.createElement("input");
      input.type = "file";
      input.webkitdirectory = true;
      input.onchange = e => {
        readFiles(e.target.files);
      };
      input.click();
    }

    function readFiles(files) {
      waypoints = [];
      deathpoints = [];
      storagepoints = [];
      zombiepoints = [];

      let fileList = Array.from(files).filter(f => f.name.toLowerCase().endsWith(".json"));
      if(fileList.length === 0) {
        setStatus("No JSON files found in folder.");
        return;
      }

      let loaded = 0;
      fileList.forEach((file, idx) => {
        const reader = new FileReader();
        let lastFile = idx === fileList.length - 1;
        reader.addEventListener('load', (event) => {
          try {
            let jsn = JSON.parse(event.target.result);
            if(jsn.m_WayPoints) waypoints.push(...jsn.m_WayPoints);
            if(jsn.m_DeathPoints) deathpoints.push(...jsn.m_DeathPoints);
            if(jsn.m_StoragePoints) storagepoints.push(...jsn.m_StoragePoints);
            if(jsn.m_ZombiePoints) zombiepoints.push(...jsn.m_ZombiePoints);
            loaded++;
          } catch(e) {
            console.warn("Skipping invalid file:", file.name);
          }

          if(lastFile) {
            document.getElementById("timeSlider").value = "1.0";
            maxTime = getMaxTime();
            drawHeatmap(1.0);
            setStatus(`${loaded} files loaded â†’ ${waypoints.length} waypoints, ${deathpoints.length} deaths, ${storagepoints.length} storages, ${zombiepoints.length} zombies`);
          }
        });
        reader.readAsText(file);
      });
    }

    function getMaxTime() {
      let max = 0.0;
      for(let i = 0; i < waypoints.length; i++) {
        let playerwaypoints = waypoints[i];
        for(let j = 0; j < playerwaypoints.length; j++) {
          max = Math.max(max, playerwaypoints[j][1]);
        }
      }
      [...deathpoints, ...storagepoints, ...zombiepoints].forEach(p => max = Math.max(max, p[1]));
      return max;
    }

    var lastTimeValue = 1.0;
    document.getElementById('timeSlider').addEventListener("input", function () {
      if(this.value != lastTimeValue) {
        lastTimeValue = this.value;
        drawHeatmap(this.value);
      }
    });

    document.getElementById('intensitySlider').addEventListener("input", function () {
      drawHeatmap(lastTimeValue);
    });

    document.querySelectorAll("#showWaypoints,#showDeaths,#showStorages,#showZombies")
      .forEach(cb => cb.addEventListener("change", ()=> drawHeatmap(lastTimeValue)));

    function drawHeatmap(time) {
      let value = document.getElementById("mapSelect").value;
      let size = mapSize.get(value);
      let intensity = parseFloat(document.getElementById("intensitySlider").value);

      let canvas = document.getElementById("mapCanvas");
      let ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if(document.getElementById("showWaypoints").checked){
        let heatCanvas = document.createElement("canvas");
        heatCanvas.width = canvas.width;
        heatCanvas.height = canvas.height;
        let heatCtx = heatCanvas.getContext("2d");

        for(let i = 0; i < waypoints.length; i++) {
          let playerwaypoints = waypoints[i];
          for(let j = 0; j < playerwaypoints.length; j++) {
            let waypoint = playerwaypoints[j];
            if(waypoint[1]/maxTime > time) continue;
            let x = canvas.width / size * waypoint[0];
            let y = canvas.height - (canvas.height / size * waypoint[2]);
            let grd = heatCtx.createRadialGradient(x, y, 0, x, y, 20*intensity);
            grd.addColorStop(0, "rgba(255,255,255,"+(0.15*intensity)+")");
            grd.addColorStop(1, "rgba(255,255,255,0)");
            heatCtx.fillStyle = grd;
            heatCtx.fillRect(x-20*intensity, y-20*intensity, 40*intensity, 40*intensity);
          }
        }

        let img = heatCtx.getImageData(0, 0, heatCanvas.width, heatCanvas.height);
        let data = img.data;
        for(let i = 0; i < data.length; i += 4) {
          let alpha = data[i+3] / 255;
          if(alpha > 0) {
            let color = getHeatColor(alpha);
            data[i] = color[0];
            data[i+1] = color[1];
            data[i+2] = color[2];
            data[i+3] = Math.min(255, alpha * 255);
          }
        }
        heatCtx.putImageData(img, 0, 0);
        ctx.drawImage(heatCanvas, 0, 0);
      }

      if(document.getElementById("showDeaths").checked){
        ctx.globalAlpha = 1.0;
        deathpoints.forEach(p => {
          let x = canvas.width / size * p[0];
          let y = canvas.height - (canvas.height / size * p[2]);
          ctx.beginPath();
          ctx.strokeStyle = "yellow";
          ctx.arc(x, y, 5, 0, 2 * Math.PI);
          ctx.stroke();
        });
      }

      if(document.getElementById("showStorages").checked){
        ctx.globalAlpha = 0.8;
        storagepoints.forEach(p => {
          let x = canvas.width / size * p[0];
          let y = canvas.height - (canvas.height / size * p[2]);
          ctx.beginPath();
          ctx.strokeStyle = "red";
          ctx.rect(x-4, y-4, 8, 8);
          ctx.stroke();
        });
      }

      if(document.getElementById("showZombies").checked){
        ctx.globalAlpha = 0.4;
        zombiepoints.forEach(p => {
          let x = canvas.width / size * p[0];
          let y = canvas.height - (canvas.height / size * p[2]);
          ctx.beginPath();
          ctx.strokeStyle = "darkorange";
          ctx.arc(x, y, 4, 0, 2 * Math.PI);
          ctx.stroke();
        });
      }

      ctx.globalAlpha = 1.0;
    }

    function getHeatColor(t) {
      let r=0,g=0,b=0;
      if(t < 0.25){ r=0; g=t*4*255; b=255; }
      else if(t < 0.5){ r=0; g=255; b=(1-(t-0.25)*4)*255; }
      else if(t < 0.75){ r=(t-0.5)*4*255; g=255; b=0; }
      else { r=255; g=(1-(t-0.75)*4)*255; b=0; }
      return [r,g,b];
    }

    function save() {
      let mapCanvas = document.getElementById("mapCanvas");
      let mapImage = document.getElementById("mapImage");

      html2canvas(mapImage, {useCORS:true}).then(canvas => {
        canvas.toBlob(function(blob){
          saveAs(blob, "heatmap.png");
        });
      });
    }

    function toggleTheme() {
      let body = document.body;
      let btn = document.getElementById("themeToggle");
      if(body.classList.contains("light")){
        body.classList.remove("light");
        btn.textContent = "Enter the light side";
      } else {
        body.classList.add("light");
        btn.textContent = "Enter the dark side";
      }
    }
  </script>
</body>
</html>
